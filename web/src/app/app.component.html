<div class="page" *ngIf="targetSet() as target">
  <header class="header">
    <h1>{{ title }}</h1>
    <p class="subtitle">Demographic raking first, party post-stratification second.</p>
  </header>

  <div class="layout">
    <section class="panel inputs">
      <h2>Variables</h2>
      <div class="stack">
        <label *ngFor="let variable of target.variables" class="toggle" [class.party]="variable.key === 'PARTY'">
          <input
            type="checkbox"
            [checked]="selectedVariables().has(variable.key)"
            (change)="toggleVariable(variable.key, $event.target.checked)"
            [disabled]="variable.key === 'PARTY'"
          />
          <span>{{ variable.label }}</span>
        </label>
      </div>

      <h2>Refusal % (per variable)</h2>
      <div class="stack">
        <label *ngFor="let variable of target.variables" class="field">
          <span>{{ variable.label }}</span>
          <input
            type="number"
            step="0.01"
            min="0"
            max="0.9"
            [value]="refusalRates()[variable.key] ?? 0"
            (input)="updateRefusal(variable.key, $event)"
          />
        </label>
      </div>

      <h2>Caps</h2>
      <div class="caps">
        <label class="field">
          <span>Min</span>
          <input type="number" step="0.1" min="0" [value]="caps().min" (input)="updateCaps('min', $event)" />
        </label>
        <label class="field">
          <span>Max</span>
          <input type="number" step="0.1" min="0" [value]="caps().max" (input)="updateCaps('max', $event)" />
        </label>
      </div>

      <h2>Party Targets</h2>
      <div class="stack">
        <label *ngFor="let category of partyCategories()" class="field">
          <span>{{ category.label }}</span>
          <input type="number" step="0.01" min="0" max="1" [value]="partyTargets()[category.key]" (input)="updatePartyTarget(category.key, $event)" />
        </label>
      </div>
    </section>

    <section class="panel counts">
      <h2>Category Counts</h2>
      <p class="hint">Paste sample counts per category. Totals auto-normalize to shares.</p>

      <div *ngFor="let variable of target.variables" class="counts-group">
        <h3>{{ variable.label }}</h3>
        <table>
          <thead>
            <tr>
              <th>Category</th>
              <th>Target Share</th>
              <th>Sample Count</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let category of variable.categories">
              <td>{{ category.label }}</td>
              <td>{{ category.share | number: '1.2-2' }}</td>
              <td>
                <input
                  type="number"
                  min="0"
                  [value]="counts()[variable.key]?.[category.key] ?? 0"
                  (input)="updateCount(variable.key, category.key, $event)"
                />
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="actions">
        <button type="button" class="secondary" (click)="resetCounts()">Reset Counts</button>
        <button type="button" (click)="compute()" [disabled]="isComputing()">{{ isComputing() ? 'Computing…' : 'Compute' }}</button>
      </div>

      <p *ngIf="errorMessage()" class="error">{{ errorMessage() }}</p>
    </section>

    <section class="panel results">
      <h2>Results</h2>
      <div *ngIf="computeResult() as result; else emptyState">
        <table>
          <thead>
            <tr>
              <th>Variable</th>
              <th>Category</th>
              <th>Target</th>
              <th>Sample Share</th>
              <th>Weight</th>
              <th>Cap Hit?</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of result.categoryTable" [ngClass]="{ capped: row.capped }">
              <td>{{ row.variable }}</td>
              <td>{{ row.category }}</td>
              <td>{{ row.target | number: '1.2-2' }}</td>
              <td>{{ row.sampleShare | number: '1.2-2' }}</td>
              <td>{{ row.weight | number: '1.2-2' }}</td>
              <td>{{ row.capped ? 'Yes' : 'No' }}</td>
            </tr>
          </tbody>
        </table>

        <div class="diagnostics">
          <h3>Diagnostics</h3>
          <p>Iterations: {{ result.diagnostics.iterations }}</p>
          <p>Converged: {{ result.diagnostics.converged ? 'Yes' : 'No' }}</p>
          <div *ngIf="result.diagnostics.capHits.length > 0">
            <h4>Cap Hits</h4>
            <ul>
              <li *ngFor="let cap of result.diagnostics.capHits">
                {{ cap.variable }} → {{ cap.category }}: suggested {{ cap.suggestedWeight | number: '1.2-2' }}, capped to
                {{ cap.cappedTo | number: '1.2-2' }}
              </li>
            </ul>
          </div>
        </div>

        <button type="button" (click)="exportCategoryCsv()">Export Category Weights CSV</button>
      </div>
      <ng-template #emptyState>
        <p class="hint">Compute weights to see results and diagnostics.</p>
      </ng-template>
    </section>
  </div>
</div>

<div *ngIf="!targetSet()" class="loading">
  <p>Loading ACS targets…</p>
</div>

